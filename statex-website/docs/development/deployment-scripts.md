# Deployment Scripts Documentation

## Overview

This document describes the deployment scripts available in the StateX project for managing application deployment, SSL certificates, and environment management.

## Available Scripts

### Core Deployment Scripts

#### `deploy.sh` - Main Production Deployment

**Purpose**: Complete production deployment with comprehensive monitoring and error handling.

**Usage**:

```bash
./scripts/deploy.sh [options]
```

**Options**:

- `--setup`: Run initial setup (create .env files, configure SSL)
- `--deploy`: Deploy the application (default)
- `--restart`: Restart all services
- `--status`: Show status of all services
- `--logs [service]`: Show logs for all or specific service
- `--help`: Show help message

**Features**:

- Environment validation
- Docker status checking
- User UID auto-detection
- Git pull with conflict resolution
- SSL volume initialization
- Comprehensive build monitoring
- Health checks for all services
- Detailed progress reporting
- Error handling and rollback

#### `dev-deploy.sh` - Development Deployment

**Purpose**: Quick development environment deployment.

**Usage**:

```bash
./scripts/dev-deploy.sh [options]
```

**Options**:

- `--build`: Force rebuild of containers
- `--logs`: Show logs after deployment
- `--help`: Show help message

### SSL Management Scripts

#### `manage-ssl.sh` - SSL Certificate Management

**Purpose**: Manage SSL certificates for both development and production environments.

**Usage**:

```bash
./scripts/manage-ssl.sh [options]
```

**Options**:

- `--status`: Show SSL certificate status
- `--init`: Initialize SSL volume with certificates
- `--backup [directory]`: Backup SSL certificates
- `--restore [directory]`: Restore SSL certificates
- `--regenerate`: Regenerate SSL certificates
- `--restart-letsencrypt`: Restart Let's Encrypt service
- `--help`: Show help message

**Features**:

- Docker volume management
- Let's Encrypt container status monitoring
- Local and Docker volume backup/restore
- Certificate regeneration
- Let's Encrypt service management

#### `generate_ssl.sh` - SSL Certificate Generation

**Purpose**: Generate SSL certificates based on environment.

**Usage**:

```bash
./scripts/generate_ssl.sh [options]
```

**Options**:

- `--force-self-signed`: Force self-signed certificates in production
- No options: Automatic environment detection

**Features**:

- **Development**: Generates self-signed certificates for localhost
- **Production**: Generates Let's Encrypt certificates for domains
- Environment-specific configuration updates
- Automatic certificate renewal setup

### Environment Management Scripts

#### `switch_env.sh` - Environment Switching

**Purpose**: Switch between development and production environments.

**Usage**:

```bash
./scripts/switch_env.sh [environment]
```

**Environments**:

- `development`: Switch to development environment
- `production`: Switch to production environment

**Features**:

- Environment file symlinking
- Environment validation
- Automatic configuration updates

#### `setup_production.sh` - Production Environment Setup

**Purpose**: Initial production environment configuration.

**Usage**:

```bash
./scripts/setup_production.sh
```

**Features**:

- Production environment file creation
- SSL configuration setup
- Security key generation
- SSL data structure creation

### Utility Scripts

#### `rebuild.sh` - Container Rebuilding

**Purpose**: Rebuild containers for specific environments.

**Usage**:

```bash
./scripts/rebuild.sh [environment]
```

**Environments**:

- `development`: Rebuild development containers
- `production`: Rebuild production containers

**Features**:

- Environment-aware rebuilding
- Cache clearing options
- Health check verification

#### `check-versions.sh` - Version Compatibility Checking

**Purpose**: Check version compatibility across environments.

**Usage**:

```bash
./scripts/check-versions.sh [options]
```

**Options**:

- `--local`: Check local environment versions
- `--docker`: Check Docker environment versions
- `--all`: Check all environments (default)

**Features**:

- Node.js version checking
- NPM package version verification
- Docker image version comparison
- Environment compatibility analysis

## SSL Certificate Management

### Development Environment

- **Self-signed certificates** for localhost
- Stored in `./ssl/` directory
- Automatically generated by `generate_ssl.sh`

### Production Environment

- **Let's Encrypt certificates** for domains
- Automatically managed by Docker service
- Stored in Docker volume `statex_ssl_data`
- Automatic renewal every 12 hours
- Nginx auto-reload on certificate updates

### Let's Encrypt Integration

The production environment includes a dedicated Let's Encrypt service that:

- Generates initial certificates on first run
- Automatically renews certificates
- Copies certificates to the SSL volume
- Reloads Nginx after updates
- Handles multiple domains (main + www + api)

## Directory Structure

```text
scripts/
├── deploy.sh              # Main production deployment
├── dev-deploy.sh          # Development deployment
├── manage-ssl.sh          # SSL certificate management
├── generate_ssl.sh        # SSL certificate generation
├── switch_env.sh          # Environment switching
├── setup_production.sh    # Production setup
├── rebuild.sh             # Container rebuilding
└── check-versions.sh      # Version compatibility

ssl/                       # Local SSL certificates
letsencrypt/               # Let's Encrypt data
logs/certbot/              # Let's Encrypt logs
```

## Environment Variables

### Required for Production

- `VIRTUAL_HOST`: Main domain (e.g., statex.cz)
- `LETSENCRYPT_EMAIL`: Email for Let's Encrypt notifications
- `NODE_ENV`: Set to "production"

### SSL Configuration

- `ALLOW_SELF_SIGNED`: false for production, true for development
- `SSL_MODE`: "production" for Let's Encrypt, "development" for self-signed

## Best Practices

1. **Always check environment** before running production scripts
2. **Backup SSL certificates** before major changes
3. **Monitor Let's Encrypt logs** for certificate issues
4. **Use environment-specific scripts** for different deployments
5. **Verify health checks** after deployment
6. **Keep SSL certificates secure** with proper permissions

## Troubleshooting

### Common Issues

- **SSL volume not found**: Run `./scripts/manage-ssl.sh --init`
- **Let's Encrypt failures**: Check logs with `docker logs statex_letsencrypt`
- **Certificate renewal issues**: Restart service with `./scripts/manage-ssl.sh --restart-letsencrypt`
- **Permission errors**: Verify SSL directory permissions and ownership

### Log Locations

- **Application logs**: `docker compose -f docker-compose.production.yml logs`
- **Let's Encrypt logs**: `./logs/certbot/`
- **Nginx logs**: `./logs/nginx/`
- **Container logs**: `docker logs [container_name]`
